<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Web Flores Timur</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <!-- CSS untuk plugin fullscreen -->
    <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet" />

    <!-- CSS untuk plugin search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            width: 100%;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background-color: white;
            padding: 6px 8px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
 
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Flores Timur</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">Tentang</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Modal -->
    <div class="modal fade" id="kecamatanModal" tabindex="-1" aria-labelledby="kecamatanModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="kecamatanModalLabel">Informasi Kecamatan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="kecamatanModalBody">
            <!-- Content will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aboutModalLabel">Tentang Aplikasi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Aplikasi Peta Web Flores Timur ini dibuat sebagai bagian dari Praktikum Pemrograman Geospasial Web.</p>
            <p>Dibuat oleh: Felisha Dwina</p>
            <p>NIM: 24/543891/SV/25284</p>
            <p>Kelas: B</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- JS untuk plugin fullscreen -->
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.min.js"></script>

    <!-- JS untuk plugin search -->
    <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var mapCenter = [-8.3435, 122.9821];
        var initialZoom = 13;

        var map = L.map('map', {
            fullscreenControl: true,
        }).setView(mapCenter, initialZoom);

        map.createPane('batasKecamatanPane');
        map.getPane('batasKecamatanPane').style.zIndex = 410;
        map.createPane('sungaiPane');
        map.getPane('sungaiPane').style.zIndex = 420;
        map.createPane('jalanPane');
        map.getPane('jalanPane').style.zIndex = 430;
        map.createPane('toponimiPane');
        map.getPane('toponimiPane').style.zIndex = 440;

        var openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        var esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        var baseMaps = {
            "OpenStreetMap": openStreetMap,
            "Esri Satellite": esriSatellite
        };

        openStreetMap.addTo(map);

        // --- GRADUATED SYMBOLOGY AND LEGEND --- 

        // Fungsi untuk mendapatkan warna berdasarkan jumlah penduduk (3 kelas, interval 15000)
        // Gradasi warna coklat
        function getColor(d) {
            return d > 30000 ? '#8B4513' :      // Kelas 3
                   d > 15000 ? '#CD853F' :      // Kelas 2
                               '#F5DEB3';    // Kelas 1
        }

        // Fungsi untuk menata style layer GeoJSON
        function style(feature) {
            return {
                fillColor: getColor(feature.properties.Penduduk), // Menggunakan properti 'Penduduk'
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.8
            };
        }

        function getJalanStyle(feature) {
            switch (feature.properties.NAMA_UNSUR) {
                case 'Jalan Propinsi': return { color: "#ff0000", weight: 5, opacity: 0.8 };
                case 'Jalan Kabupaten': return { color: "#ff0000", weight: 3, opacity: 0.8 };
                case 'Jalan Lain': return { color: "#ff0000", weight: 1, opacity: 0.8 };
                default: return { color: "#ff0000", weight: 1, opacity: 0.8 };
            }
        }

        // --- LAYER LOADING AND CONTROL ---

        Promise.all([
            fetch('data/batas_kecamatan.geojson').then(response => response.json()),
            fetch('data/jalan.geojson').then(response => response.json()),
            fetch('data/sungai.geojson').then(response => response.json()),
            fetch('data/toponimi.geojson').then(response => response.json())
        ]).then(function (data) {
            
            var kecamatanLayer = L.geoJson(data[0], {
                style: style,
                pane: 'batasKecamatanPane',
                onEachFeature: function (feature, layer) {
                    if (feature.properties && feature.properties.WADMKC) {
                        layer.bindTooltip(feature.properties.WADMKC, {sticky: true});
                    }
                    layer.on('click', function (e) {
                        var properties = feature.properties;
                        if (properties) {
                            document.getElementById('kecamatanModalLabel').innerText = "Informasi Kecamatan: " + properties.WADMKC;
                            document.getElementById('kecamatanModalBody').innerHTML = "<p><strong>Kecamatan:</strong> " + properties.WADMKC + "</p>" +
                                                                                        "<p><strong><i class='bi bi-people'></i> Jumlah Penduduk:</strong> " + properties.Penduduk + "</p>";
                            var kecamatanModal = new bootstrap.Modal(document.getElementById('kecamatanModal'));
                            kecamatanModal.show();
                        }
                    });
                }
            });
            var jalanLayer = L.geoJson(data[1], { 
                style: getJalanStyle,
                pane: 'jalanPane'
            });
            var sungaiLayer = L.geoJson(data[2], { 
                style: { color: "#0000FF", weight: 2, opacity: 0.9 },
                pane: 'sungaiPane'
            });
            var toponimiLayer = L.geoJson(data[3], {
                pane: 'toponimiPane',
                onEachFeature: function (feature, layer) {
                    if (feature.properties && feature.properties.NAMOBJ) {
                        layer.bindPopup(feature.properties.NAMOBJ);
                    }
                }
            });

            var searchControl = new L.Control.Search({
                layer: kecamatanLayer,
                propertyName: 'WADMKC',
                marker: false,
                moveToLocation: function(latlng, title, map) {
                    var zoom = map.getBoundsZoom(latlng.layer.getBounds());
                    map.setView(latlng, zoom); // set the view on the searched feature
                    latlng.layer.fire('click'); // open the modal
                }
            });

            map.addControl(searchControl);

            var pendudukLegendHTML = '<div style="line-height: 1.5; margin-top: 10px;">' +
                '<h6>Jumlah Penduduk</h6>' +
                '<div><i style="background:#8B4513; width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> &gt; 30000</div>' +
                '<div><i style="background:#CD853F; width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> 15000 - 30000</div>' +
                '<div><i style="background:#F5DEB3; width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> &lt; 15000</div>' +
            '</div>';

            var jalanLegendHTML = '<div style="line-height: 1.5; margin-top: 10px;">' +
                '<h6>Legenda Jalan</h6>' +
                '<div><i style="background: #ff0000; height: 5px; width: 20px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> Jalan Propinsi</div>' +
                '<div><i style="background: #ff0000; height: 3px; width: 20px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> Jalan Kabupaten</div>' +
                '<div><i style="background: #ff0000; height: 1px; width: 20px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> Jalan Lain</div>' +
            '</div>';

            var sungaiLegendHTML = '<div style="line-height: 1.5; margin-top: 10px;">' +
                '<h6>Legenda Sungai</h6>' +
                '<div><i style="background: #0000FF; height: 2px; width: 20px; display: inline-block; vertical-align: middle; margin-right: 5px;"></i> Sungai</div>' +
            '</div>';

            var overlays = {
                ["Batas Kecamatan" + pendudukLegendHTML]: kecamatanLayer,
                ["Jalan" + jalanLegendHTML]: jalanLayer,
                ["Sungai" + sungaiLegendHTML]: sungaiLayer,
                "Toponimi": toponimiLayer
            };

            // Tambahkan layer default ke peta
            kecamatanLayer.addTo(map);

            // Tambahkan kontrol layer
            var layerControl = L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);

            function updateLayerControl() {
                if (window.innerWidth < 768) {
                    layerControl.collapse();
                } else {
                    layerControl.expand();
                }
            }

            updateLayerControl();
            window.addEventListener('resize', updateLayerControl);

            // Atur view peta sesuai layer kecamatan
            map.fitBounds(kecamatanLayer.getBounds());
        });    </script>
</body>
</html>